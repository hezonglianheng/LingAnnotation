<!DOCTYPE html>
<html>
<head>
    <title>语料标注详情 - 语言学数据标注平台</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
    <style>
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-size: 1.8rem;
            font-weight: 600;
        }
        .corpus-info {
            background-color: #e8f0fe;
            padding: 15px 30px;
            border-bottom: 1px solid #d2e3fc;
            font-size: 0.95rem;
            color: #5f6368;
            display: flex;
            justify-content: space-between;
        }
        .corpus-id {
            font-weight: 600;
            color: #1a73e8;
        }
        .content-container {
            padding: 25px 30px;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a73e8;
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 18px;
            background: #1a73e8;
            margin-right: 10px;
            border-radius: 2px;
        }
        .original-text {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.1rem;
            position: relative;
        }
        .underlined {
            position: relative;
            display: inline-block;
            cursor: pointer;
            padding-bottom: 20px;
            margin: 0 2px;
        }
        .underlined::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: 18px;
            width: 100%;
            height: 3px;
            background: var(--underline-color, #3498db);
            border-radius: 2px;
            transform-origin: left;
            transform: scaleX(0.95);
        }
        .underlined .label {
            position: absolute;
            left: 50%;
            bottom: -2px;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            font-size: 0.8rem;
            padding: 2px 10px;
            border-radius: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .underlined:hover .label {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        .underlined:hover::after {
            background: #e74c3c;
            height: 4px;
        }
        .selected {
            background: #ffe0e0 !important;
            box-shadow: 0 0 0 2px #e74c3c;
        }
        .labels-list, .relations-list {
            margin-bottom: 30px;
        }
        .label-card, .relation-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .label-info-section, .relation-info-section {
            display: flex;
            align-items: center;
            flex: 1;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .relation-type-section, .relation-object-section {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            width: 100%;
        }
        
        .relation-type-section:last-child, .relation-object-section:last-child {
            margin-bottom: 0;
        }
        
        .relation-type-label, .relation-object-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #5f6368;
            min-width: 80px;
            margin-right: 10px;
        }
        
        .label-info-section {
            flex-direction: row;
            align-items: center;
        }
        
        .label-meta-section, .relation-meta-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 15px;
            min-width: 120px;
        }
        
        .relation-type {
            white-space: nowrap;
        }
        
        .relation-detail {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            flex-wrap: wrap;
        }
        
        .relation-source, .relation-target {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            color: #5f6368;
            margin: 2px;
        }
        
        .relation-id {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .relation-id i {
            font-size: 0.7rem;
        }
        
        /* 关系卡片特殊样式 */
        .relation-card {
            border-left: 4px solid #1a73e8;
        }
        
        .relation-card:hover {
            border-left-color: #0d47a1;
        }
        
        .label-id {
            font-size: 0.8rem;
            color: #1a73e8;
            background: #e8f0fe;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .label-id i {
            font-size: 0.7rem;
        }
        
        .label-type {
            font-size: 0.95rem;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .label-content {
            font-size: 1rem;
            color: #202124;
            margin-right: 10px;
            flex: 1;
        }
        
        .label-position {
            font-size: 0.85rem;
            color: #5f6368;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .label-position i {
            font-size: 0.75rem;
        }
        .action-btns .btn {
            margin-left: 8px;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            .legend {
                flex-wrap: wrap;
            }
            
            .label-card, .relation-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .label-info-section, .relation-info-section {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .label-meta-section, .relation-meta-section {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .action-btns {
                width: 100%;
                text-align: center;
            }
            
            .relation-detail {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .relation-type-section, .relation-object-section {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 12px;
            }
            
            .relation-type-label, .relation-object-label {
                margin-bottom: 5px;
                margin-right: 0;
                min-width: auto;
            }
        }
        
        /* 选中文本的高亮样式 */
        ::selection {
            background-color: #bbdefb;
            color: #000;
        }
        
        /* 标签按钮悬停效果 */
        .btn-outline-info:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* 选中文本提示框动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #selectionInfoBox {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 删除按钮样式 */
        .delete-label-btn, .delete-relation-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .delete-label-btn:hover, .delete-relation-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .delete-label-btn:active, .delete-relation-btn:active {
            transform: scale(0.95);
        }
        
        .delete-label-btn:disabled, .delete-relation-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 标签卡片悬停效果 */
        .label-card, .relation-card {
            transition: all 0.3s ease;
        }
        
        .label-card:hover, .relation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* 关系建立面板样式 */
        #relationPanel {
            border-left: 4px solid #1a73e8 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;
        }
        
        .label-selector {
            transition: all 0.3s ease !important;
        }
        
        .label-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .label-selector.selected {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
            color: #1976d2 !important;
            transform: scale(1.05);
        }
        
        .relation-type-selector {
            transition: all 0.3s ease;
        }
        
        .relation-type-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 对象选择器样式 */
        .object-selector {
            transition: all 0.3s ease !important;
        }
        
        .object-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .object-selector.selected {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
            color: #1976d2 !important;
            transform: scale(1.05);
        }
        
        .relation-selector {
            background: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }
        
        .relation-selector:hover {
            background: #ffecb3 !important;
            border-color: #ffcc02 !important;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-title">语料标注详情</div>
    </div>
    <div class="corpus-info">
        <div>当前语料ID: <span class="corpus-id">{{ item.id }}</span></div>
        <div>更新时间: {{ item.update_time|default:"-" }}</div>
    </div>
    <div class="content-container">
        <div class="section-title">语料原文</div>
        <div class="text-selection-info" style="margin-bottom:10px;font-size:0.9rem;display:none;background:#f5f5f5;padding:8px 12px;border-radius:4px;border-left:3px solid #1a73e8;">
            <i class="fas fa-mouse-pointer"></i> <span id="selectionStatus">请在文本中选择要标注的内容</span>
        </div>
        <div class="original-text" id="originalText">
            <p>
            {% for seg in segments %}
                {% if seg.label %}
                    <span class="underlined" data-start="{{ seg.start }}" data-end="{{ seg.end }}" style="--underline-color: {{ seg.color }};">
                        <span class="text-main">{{ seg.text }}</span>
                        <span class="label">{{ seg.label.type }}</span>
                    </span>
                {% else %}
                    <span data-start="{{ seg.start }}" data-end="{{ seg.end }}">{{ seg.text }}</span>
                {% endif %}
            {% endfor %}
            </p>
        </div>
        <div class="legend">
            {% for label in labels %}
                <div class="legend-item">
                    <div class="legend-color" style="background-color: {{ label.color }};"></div>
                    <span>{{ label.name }}</span>
                </div>
            {% endfor %}
        </div>
        <div class="section-title">可用标签类型</div>
        <div class="alert alert-info" style="font-size:0.9rem;background-color:#e8f4f8;border-color:#b8e0ee;">
            <i class="fas fa-info-circle"></i> 使用方法：先在文本中选中要标注的内容，再点击下方标签类型完成标注
        </div>
        <ul class="list-inline">
            {% for label in labels %}
                <li class="list-inline-item" style="margin-bottom:12px;">
                    <button class="btn btn-outline-info btn-sm label-btn" onclick="applyLabel('label', '{{ label.name }}', '{{ label.color }}')" 
                            style="border-color:{{ label.color }};position:relative;overflow:hidden;transition:all 0.3s ease;">
                        <span style="background: {{ label.color }}; color: #fff; border-radius: 4px; padding: 2px 8px;">{{ label.name }}</span>
                        <span style="display:block;font-size:10px;margin-top:3px;color:#666;">点击应用</span>
                    </button>
                </li>
            {% endfor %}
        </ul>
        
        <style>
            .label-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .label-btn:before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                transition: left 0.6s ease;
            }
            .label-btn:hover:before {
                left: 100%;
            }
        </style>
        <div class="section-title">标签标注</div>
        <div class="labels-list" id="labelsList">
            {% for lab in item.labels %}
                {% with color="#39c5bb" %}
                    {% for label in labels %}
                        {% if label.name == lab.type %}
                            {% with color=label.color %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    <div class="label-card" data-id="{{ lab.id }}">
                        <div class="label-info-section">
                            <span class="label-type" style="background: {{ color }}">{{ lab.type }}</span>
                            <span class="label-content">{{ lab.text }}</span>
                        </div>
                        <div class="label-meta-section">
                            <span class="label-id"><i class="fas fa-hashtag"></i> {{ lab.id|default_if_none:"未知" }}</span>
                            <span class="label-position"><i class="fas fa-map-marker-alt"></i> {{ lab.start }} - {{ lab.end }}</span>
                        </div>
                        <div class="action-btns">
                            <button class="btn btn-danger btn-sm delete-label-btn" onclick="deleteLabel({{ lab.start }}, {{ lab.end }}, '{{ lab.type }}', this)">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                {% endwith %}
            {% empty %}
                <div class="text-muted">暂无标签</div>
            {% endfor %}
        </div>
        <div class="section-title">可用关系类型</div>
        <div class="available-relations-list" style="margin-bottom: 30px;">
            {% for rel in relations %}
                <div class="relation-type-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 4px solid {{ rel.color|default:'#f39c12' }};">
                    <div style="display: flex; align-items: center;">
                        <span style="background-color: {{ rel.color|default:'#f39c12' }}; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 600; margin-right: 15px; font-size: 0.95rem;">
                            {{ rel.name }}
                        </span>
                        <span style="color: #5f6368; font-size: 0.9rem;">
                            <i class="fas fa-link"></i> 关系类型
                        </span>
                    </div>
                    <div style="font-size: 0.8rem; color: #1a73e8; background: #e8f0fe; padding: 2px 8px; border-radius: 12px; font-weight: 500;">
                        <i class="fas fa-tag"></i> {{ rel.type|default:"relation" }}
                    </div>
                </div>
            {% empty %}
                <div class="text-muted" style="padding: 20px; text-align: center; background: #f8f9fa; border: 1px dashed #ddd; border-radius: 8px;">
                    <i class="fas fa-info-circle"></i> 暂无可用关系类型
                </div>
            {% endfor %}
        </div>

        <div class="section-title">已标注关系</div>
        <div class="relations-list" id="relationsList">
            {% for rel in item.relations %}
                <div class="relation-card" data-relation-id="{{ rel.id }}">
                    <div class="relation-info-section">
                        <div class="relation-type-section">
                            <span class="relation-type-label">关系类型:</span>
                            <span class="relation-type" style="background-color: #1a73e8; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600; margin-left: 8px;">
                                {{ rel.type }}
                            </span>
                        </div>
                        <div class="relation-object-section">
                            <span class="relation-object-label">关系对象:</span>
                            <span class="relation-detail">
                                {% if rel.start.object_type == 'relation' %}
                                    <span class="relation-source" style="background-color: #fff3cd; color: #856404;">关系:{{ rel.start.type }}[ID:{{ rel.start.id }}]</span>
                                {% else %}
                                    <span class="relation-source">标签:{{ rel.start.type }}[ID:{{ rel.start.id }}]</span>
                                {% endif %}
                                <i class="fas fa-arrow-right" style="margin: 0 8px; color: #1a73e8;"></i>
                                {% if rel.end.object_type == 'relation' %}
                                    <span class="relation-target" style="background-color: #fff3cd; color: #856404;">关系:{{ rel.end.type }}[ID:{{ rel.end.id }}]</span>
                                {% else %}
                                    <span class="relation-target">标签:{{ rel.end.type }}[ID:{{ rel.end.id }}]</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="relation-meta-section">
                        <span class="relation-id" style="font-size: 0.8rem; color: #1a73e8; background: #e8f0fe; padding: 2px 8px; border-radius: 12px; font-weight: 500;">
                            <i class="fas fa-hashtag"></i> {{ rel.id|default_if_none:"未知" }}
                        </span>
                        <div class="action-btns" style="margin-left: 10px;">
                            <button class="btn btn-danger btn-sm delete-relation-btn" 
                                    onclick="deleteRelation({{ rel.id }}, this)"
                                    style="padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-muted" style="padding: 20px; text-align: center; background: #f8f9fa; border: 1px dashed #ddd; border-radius: 8px;">
                    <i class="fas fa-exclamation-circle"></i> 当前语料暂无已标注关系
                </div>
            {% endfor %}
        </div>
        <div class="section-title">操作</div>
        <div class="controls mb-3">
            <button class="btn btn-primary" onclick="toggleRelationMode()">
                <i class="fas fa-link"></i> <span id="relationModeText">建立关系</span>
            </button>
            <!--
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-download"></i> 导出数据
            </button>
            -->
            <button class="btn btn-secondary" onclick="window.close()">
                <i class="fas fa-arrow-left"></i> 关闭页面
            </button>
        </div>

        <!-- 关系建立面板 -->
        <div id="relationPanel" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px;">
            <div class="section-title" style="margin-bottom: 15px;">
                <i class="fas fa-link"></i> 建立关系
            </div>
            
            <div class="alert alert-info" style="font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> 请按顺序：1) 选择两个标注对象 2) 选择关系类型 3) 点击建立关系
            </div>

            <h6 style="margin-bottom: 10px; color: #1a73e8;">步骤1：选择对象 (已选择: <span id="selectedCount">0</span>/2)</h6>
            <div class="mb-3">
                <!-- 标签对象选择区域 -->
                <div style="margin-bottom: 15px;">
                    <h6 style="font-size: 0.9rem; margin-bottom: 8px; color: #5f6368;">选择标签对象：</h6>
                    <div id="labelSelectionArea" style="max-height: 150px; overflow-y: auto; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                        {% for lab in item.labels %}
                            <span class="object-selector label-selector" 
                                  data-object-type="label"
                                  data-type="{{ lab.type }}" 
                                  data-start="{{ lab.start }}" 
                                  data-end="{{ lab.end }}" 
                                  data-id="{{ lab.id }}"
                                  style="display: inline-block; margin: 5px; padding: 8px 12px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-tag"></i> <strong>{{ lab.type }}</strong> [{{ lab.start }}-{{ lab.end }}]: "{{ lab.text|truncatechars:20 }}"
                            </span>
                        {% empty %}
                            <div class="text-muted">当前语料暂无可用标签对象</div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- 关系对象选择区域 -->
                <div>
                    <h6 style="font-size: 0.9rem; margin-bottom: 8px; color: #5f6368;">选择关系对象：</h6>
                    <div id="relationSelectionArea" style="max-height: 150px; overflow-y: auto; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                        {% for rel in item.relations %}
                            <span class="object-selector relation-selector" 
                                  data-object-type="relation"
                                  data-type="{{ rel.type }}" 
                                  data-id="{{ rel.id }}"
                                  style="display: inline-block; margin: 5px; padding: 8px 12px; background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 20px; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-link"></i> <strong>{{ rel.type }}</strong> [ID:{{ rel.id }}]: 
                                {% if rel.start.object_type == 'relation' %}关系:{{ rel.start.type }}{% else %}标签:{{ rel.start.type }}{% endif %}→{% if rel.end.object_type == 'relation' %}关系:{{ rel.end.type }}{% else %}标签:{{ rel.end.type }}{% endif %}
                            </span>
                        {% empty %}
                            <div class="text-muted">当前语料暂无可用关系对象</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <h6 style="margin-bottom: 10px; color: #1a73e8;">步骤2：选择关系类型</h6>
            <div class="mb-3" id="relationTypeArea" style="padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                {% for rel in relations %}
                    <button class="btn btn-outline-warning relation-type-selector" 
                            data-name="{{ rel.name }}" 
                            data-color="{{ rel.color|default:'#f39c12' }}"
                            style="margin: 5px;">
                        {{ rel.name }}
                    </button>
                {% empty %}
                    <div class="text-muted">暂无可用关系类型</div>
                {% endfor %}
            </div>

            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn btn-success" id="submitRelation" disabled onclick="submitRelation()">
                    <i class="fas fa-check"></i> 建立关系
                </button>
                <button class="btn btn-secondary" onclick="cancelRelationMode()">
                    <i class="fas fa-times"></i> 取消
                </button>
                <span id="relationPreview" style="color: #1a73e8; font-weight: 500;"></span>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
<script>
    // 关系建立相关变量
    let relationMode = false;
    let selectedLabelsForRelation = [];
    let selectedRelationType = null;

    // 切换关系建立模式
    function toggleRelationMode() {
        relationMode = !relationMode;
        const panel = document.getElementById('relationPanel');
        const modeText = document.getElementById('relationModeText');
        
        if (relationMode) {
            panel.style.display = 'block';
            modeText.textContent = '退出关系模式';
            resetRelationSelection();
        } else {
            panel.style.display = 'none';
            modeText.textContent = '建立关系';
            resetRelationSelection();
        }
    }

    // 取消关系建立模式
    function cancelRelationMode() {
        relationMode = false;
        document.getElementById('relationPanel').style.display = 'none';
        document.getElementById('relationModeText').textContent = '建立关系';
        resetRelationSelection();
    }

    // 重置关系选择状态
    function resetRelationSelection() {
        selectedLabelsForRelation = [];
        selectedRelationType = null;
        
        // 重置标注对象选择状态
        document.querySelectorAll('.object-selector').forEach(el => {
            const objectType = el.getAttribute('data-object-type');
            el.style.background = objectType === 'label' ? '#f0f0f0' : '#fff3cd';
            el.style.borderColor = objectType === 'label' ? '#ddd' : '#ffeaa7';
            el.style.color = '#333';
        });
        
        // 重置关系类型选择状态
        document.querySelectorAll('.relation-type-selector').forEach(el => {
            el.classList.remove('btn-warning');
            el.classList.add('btn-outline-warning');
        });
        
        updateRelationUI();
    }
    // 导出数据
    function exportData() {
        alert('导出数据功能');
    }
    // 记录选中的标注
    let selectedLabelInfo = null;
    document.querySelectorAll('.underlined').forEach(function(el) {
        el.addEventListener('click', function(e) {
            document.querySelectorAll('.underlined').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            selectedLabelInfo = {
                start: el.getAttribute('data-start'),
                end: el.getAttribute('data-end'),
                type: el.querySelector('.label').innerText
            };
            e.stopPropagation();
        });
    });
    document.body.addEventListener('click', function(e) {
        if (!e.target.classList.contains('underlined')) {
            document.querySelectorAll('.underlined').forEach(x => x.classList.remove('selected'));
            selectedLabelInfo = null;
        }
    });
    // 删除标注
    function deleteLabel(start, end, type, buttonElement) {
        // 创建确认对话框
        const confirmBox = document.createElement('div');
        confirmBox.style.position = 'fixed';
        confirmBox.style.top = '50%';
        confirmBox.style.left = '50%';
        confirmBox.style.transform = 'translate(-50%, -50%)';
        confirmBox.style.background = 'white';
        confirmBox.style.padding = '25px';
        confirmBox.style.borderRadius = '12px';
        confirmBox.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
        confirmBox.style.zIndex = '2000';
        confirmBox.style.minWidth = '350px';
        confirmBox.style.textAlign = 'center';
        confirmBox.style.animation = 'fadeIn 0.3s ease-out';

        const labelText = buttonElement.closest('.label-card').querySelector('.label-content').textContent;
        
        confirmBox.innerHTML = `
            <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4 style="margin-bottom:15px;color:#333;">确认删除标注</h4>
            <p style="margin-bottom:20px;color:#666;">
                您确定要删除标注 "<strong>${labelText}</strong>" (${type}) 吗？<br>
                <small style="color:#999;">位置: ${start} - ${end}</small>
            </p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button id="cancelDelete" class="btn btn-secondary">取消</button>
                <button id="confirmDelete" class="btn btn-danger">确认删除</button>
            </div>
        `;

        // 创建遮罩层
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '1999';

        document.body.appendChild(overlay);
        document.body.appendChild(confirmBox);

        // 取消删除
        document.getElementById('cancelDelete').onclick = function() {
            document.body.removeChild(overlay);
            document.body.removeChild(confirmBox);
            document.removeEventListener('keydown', handleKeyDown);
        };

        // 确认删除
        document.getElementById('confirmDelete').onclick = function() {
            // 显示加载状态
            confirmBox.innerHTML = `
                <div style="color:#1a73e8;font-size:48px;margin-bottom:15px;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h4 style="margin-bottom:15px;color:#333;">正在删除...</h4>
                <p style="color:#666;">请稍候，正在处理您的请求</p>
            `;

            const task_id = "{{ task.task_id }}";
            const item_id = "{{ item.id }}";
            
            // 禁用按钮并显示加载状态
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中...';
            }

            $.ajax({
                url: `/details/showitem/${task_id}/${item_id}/delete_label/`,
                type: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                contentType: 'application/json',
                data: JSON.stringify({start: start, end: end, type: type}),
                success: function(res) {
                    if (res.status === 'success') {
                        // 成功动画
                        confirmBox.innerHTML = `
                            <div style="color:#4caf50;font-size:48px;margin-bottom:15px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h4 style="margin-bottom:15px;color:#4caf50;">删除成功</h4>
                            <p style="color:#666;">标注已成功删除，页面即将刷新</p>
                        `;
                        
                        // 找到对应的标注卡片并添加淡出动画
                        const labelCard = buttonElement.closest('.label-card');
                        if (labelCard) {
                            labelCard.style.transition = 'all 0.5s ease';
                            labelCard.style.opacity = '0.3';
                            labelCard.style.transform = 'translateX(20px)';
                            labelCard.style.background = '#ffebee';
                        }
                        
                        // 2秒后刷新页面
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // 失败处理
                        confirmBox.innerHTML = `
                            <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <h4 style="margin-bottom:15px;color:#f44336;">删除失败</h4>
                            <p style="margin-bottom:20px;color:#666;">${res.message}</p>
                            <button onclick="document.body.removeChild(document.querySelector('[style*=z-index\\:1999]')); document.body.removeChild(this.closest('[style*=z-index\\:2000]'));" class="btn btn-primary">关闭</button>
                        `;
                        
                        // 恢复按钮状态
                        if (buttonElement) {
                            buttonElement.disabled = false;
                            buttonElement.innerHTML = '<i class="fas fa-trash"></i> 删除';
                        }
                    }
                },
                error: function() {
                    // 错误处理
                    confirmBox.innerHTML = `
                        <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h4 style="margin-bottom:15px;color:#f44336;">请求失败</h4>
                        <p style="margin-bottom:20px;color:#666;">无法连接到服务器，请检查网络连接</p>
                        <button onclick="document.body.removeChild(document.querySelector('[style*=z-index\\:1999]')); document.body.removeChild(this.closest('[style*=z-index\\:2000]'));" class="btn btn-primary">关闭</button>
                    `;
                    
                    // 恢复按钮状态
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-trash"></i> 删除';
                    }
                }
            });
        };

        // 点击遮罩层关闭
        overlay.onclick = function() {
            document.body.removeChild(overlay);
            document.body.removeChild(confirmBox);
        };

        // 添加键盘事件监听
        const handleKeyDown = function(e) {
            if (e.key === 'Escape') {
                document.body.removeChild(overlay);
                document.body.removeChild(confirmBox);
                document.removeEventListener('keydown', handleKeyDown);
            }
        };
        document.addEventListener('keydown', handleKeyDown);
    }
    // 记录选中的文本区间
    let selectedTextInfo = null;
    // 显示选择状态信息
    const selectionStatusElement = document.getElementById('selectionStatus');
    const textSelectionInfoElement = document.querySelector('.text-selection-info');
    textSelectionInfoElement.style.display = 'block';
    
    document.getElementById('originalText').addEventListener('mouseup', function(e) {
        const selection = window.getSelection();
        if (selection && selection.rangeCount > 0 && selection.toString().length > 0) {
            const range = selection.getRangeAt(0);
            const spans = document.querySelectorAll('#originalText [data-start]');
            let start = null, end = null;
            let foundStart = false;
            for (let span of spans) {
                let segStart = parseInt(span.getAttribute('data-start'));
                let segEnd = parseInt(span.getAttribute('data-end'));
                if (!foundStart && range.startContainer === span.firstChild) {
                    start = segStart + range.startOffset;
                    foundStart = true;
                }
                if (range.endContainer === span.firstChild) {
                    end = segStart + range.endOffset;
                    break;
                }
            }
            if (start !== null && end !== null && end > start) {
                selectedTextInfo = {
                    text: selection.toString(),
                    start: start,
                    end: end
                };
                // 更新状态信息
                selectionStatusElement.innerHTML = `已选择 <strong>"${selectedTextInfo.text.substring(0, 20)}${selectedTextInfo.text.length > 20 ? '...' : ''}"</strong>，点击下方标签完成标注`;
                selectionStatusElement.parentElement.style.borderColor = '#4caf50';
                selectionStatusElement.parentElement.style.background = '#f1f8e9';
                
                // 显示选中文本提示
                showSelectionInfo(selectedTextInfo);
            } else {
                selectedTextInfo = null;
                hideSelectionInfo();
                selectionStatusElement.innerHTML = '请在文本中选择要标注的内容';
                selectionStatusElement.parentElement.style.borderColor = '#1a73e8';
                selectionStatusElement.parentElement.style.background = '#f5f5f5';
            }
        } else {
            selectedTextInfo = null;
            hideSelectionInfo();
            selectionStatusElement.innerHTML = '请在文本中选择要标注的内容';
            selectionStatusElement.parentElement.style.borderColor = '#1a73e8';
            selectionStatusElement.parentElement.style.background = '#f5f5f5';
        }
    });

    // 显示选中文本的提示信息
    function showSelectionInfo(info) {
        // 检查是否已有提示框，如果有则移除
        let existingInfo = document.getElementById('selectionInfoBox');
        if (existingInfo) {
            existingInfo.remove();
        }

        // 创建提示框
        const infoBox = document.createElement('div');
        infoBox.id = 'selectionInfoBox';
        infoBox.style.position = 'fixed';
        infoBox.style.top = '20px';
        infoBox.style.right = '20px';
        infoBox.style.padding = '15px';
        infoBox.style.background = '#f0f8ff';
        infoBox.style.border = '1px solid #1a73e8';
        infoBox.style.borderRadius = '8px';
        infoBox.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        infoBox.style.zIndex = '1000';
        infoBox.style.maxWidth = '300px';
        infoBox.style.transition = 'all 0.3s ease';

        infoBox.innerHTML = `
            <div style="font-weight:600;margin-bottom:8px;color:#1a73e8;">已选中文本</div>
            <div style="margin-bottom:10px;word-break:break-all;font-size:14px;">${info.text}</div>
            <div style="font-size:12px;color:#5f6368;margin-bottom:5px;">位置：${info.start} - ${info.end}</div>
            <div style="font-size:12px;color:#1a73e8;">请点击下方标签类型完成标注</div>
        `;

        document.body.appendChild(infoBox);
    }

    // 隐藏选中文本提示
    function hideSelectionInfo() {
        const infoBox = document.getElementById('selectionInfoBox');
        if (infoBox) {
            infoBox.remove();
        }
    }
    // 点击标签类型时，发送标注请求
    function applyLabel(labelType, labelName, labelColor) {
        if (!selectedTextInfo) {
            alert('请先用鼠标选中要标注的文本！');
            return;
        }
        const task_id = "{{ task.task_id }}";
        const item_id = "{{ item.id }}";
        
        // 显示加载状态
        const infoBox = document.getElementById('selectionInfoBox');
        if (infoBox) {
            infoBox.innerHTML += `<div style="margin-top:10px;color:#1a73e8;"><i class="fas fa-spinner fa-spin"></i> 正在应用标签"${labelName}"...</div>`;
        }
        
        $.ajax({
            url: `/details/showitem/${task_id}/${item_id}/add_label/`,
            type: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            contentType: 'application/json',
            data: JSON.stringify({
                type: labelType,
                name: labelName,
                color: labelColor,
                start: selectedTextInfo.start,
                end: selectedTextInfo.end
            }),
            success: function(res) {
                if (res.status === 'success') {
                    // 标注成功动画效果
                    if (infoBox) {
                        infoBox.style.backgroundColor = '#e6f7e6';
                        infoBox.style.borderColor = '#4caf50';
                        infoBox.innerHTML = `
                            <div style="color:#4caf50;font-weight:600;"><i class="fas fa-check-circle"></i> 标注成功</div>
                            <div style="margin:8px 0;word-break:break-all;font-size:14px;">"${selectedTextInfo.text}" 已被标注为 "${labelName}"</div>
                            <div style="margin-top:12px;text-align:center;">
                                <button onclick="window.location.reload()" class="btn btn-sm btn-outline-success">刷新页面</button>
                            </div>
                        `;
                        // 2秒后自动刷新页面
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    } else {
                        window.location.reload();
                    }
                } else {
                    if (infoBox) {
                        infoBox.style.backgroundColor = '#ffebee';
                        infoBox.style.borderColor = '#f44336';
                        infoBox.innerHTML = `
                            <div style="color:#f44336;font-weight:600;"><i class="fas fa-exclamation-circle"></i> 标注失败</div>
                            <div style="margin:8px 0;">${res.message}</div>
                            <div style="margin-top:12px;text-align:center;">
                                <button onclick="hideSelectionInfo()" class="btn btn-sm btn-outline-danger">关闭</button>
                            </div>
                        `;
                    } else {
                        alert('标注失败：' + res.message);
                    }
                }
            },
            error: function() {
                if (infoBox) {
                    infoBox.style.backgroundColor = '#ffebee';
                    infoBox.style.borderColor = '#f44336';
                    infoBox.innerHTML = `
                        <div style="color:#f44336;font-weight:600;"><i class="fas fa-exclamation-circle"></i> 请求失败</div>
                        <div style="margin:8px 0;">无法连接到服务器，请检查网络连接。</div>
                        <div style="margin-top:12px;text-align:center;">
                            <button onclick="hideSelectionInfo()" class="btn btn-sm btn-outline-danger">关闭</button>
                        </div>
                    `;
                } else {
                    alert('标注请求失败');
                }
            }
        });
    }
    // 更新关系建立UI状态
    function updateRelationUI() {
        const selectedCount = document.getElementById('selectedCount');
        const relationPreview = document.getElementById('relationPreview');
        const submitBtn = document.getElementById('submitRelation');
        
        if (selectedCount) selectedCount.textContent = selectedLabelsForRelation.length;
        
        if (selectedLabelsForRelation.length === 2 && selectedRelationType) {
            if (relationPreview) {
                const obj1Text = selectedLabelsForRelation[0].object_type === 'label' 
                    ? `标签:${selectedLabelsForRelation[0].type}` 
                    : `关系:${selectedLabelsForRelation[0].type}`;
                const obj2Text = selectedLabelsForRelation[1].object_type === 'label' 
                    ? `标签:${selectedLabelsForRelation[1].type}` 
                    : `关系:${selectedLabelsForRelation[1].type}`;
                    
                relationPreview.innerHTML = `
                    <i class="fas fa-arrow-right"></i> 
                    将建立：<strong>${obj1Text}</strong> 
                    → <strong style="color: ${selectedRelationType.color};">${selectedRelationType.name}</strong> 
                    → <strong>${obj2Text}</strong>
                `;
            }
            if (submitBtn) submitBtn.disabled = false;
        } else {
            if (relationPreview) relationPreview.textContent = '';
            if (submitBtn) submitBtn.disabled = true;
        }
    }

    // 提交关系建立
    function submitRelation() {
        if (selectedLabelsForRelation.length !== 2 || !selectedRelationType) {
            alert('请选择两个标注对象和一个关系类型');
            return;
        }
        
        const task_id = "{{ task.task_id }}";
        const item_id = "{{ item.id }}";
        
        // 显示加载状态
        const submitBtn = document.getElementById('submitRelation');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 建立中...';
        submitBtn.disabled = true;
        
        $.ajax({
            url: `/details/showitem/${task_id}/${item_id}/add_relation/`,
            type: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            contentType: 'application/json',
            data: JSON.stringify({
                object1: selectedLabelsForRelation[0],
                object2: selectedLabelsForRelation[1],
                relation: selectedRelationType
            }),
            success: function(res) {
                if (res.status === 'success') {
                    // 成功提示
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> 建立成功';
                    submitBtn.style.background = '#4caf50';
                    
                    setTimeout(function() {
                        alert('关系建立成功！页面即将刷新');
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('建立关系失败：' + res.message);
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            },
            error: function() {
                alert('建立关系请求失败，请检查网络连接');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }

    // 标注对象和关系类型选择事件委托
    document.addEventListener('click', function(e) {
        if (!relationMode) return;
        
        if (e.target.classList.contains('object-selector')) {
            const objectType = e.target.getAttribute('data-object-type');
            let objectInfo;
            
            if (objectType === 'label') {
                objectInfo = {
                    object_type: 'label',
                    type: e.target.getAttribute('data-type'),
                    start: e.target.getAttribute('data-start'),
                    end: e.target.getAttribute('data-end'),
                    id: e.target.getAttribute('data-id'),
                    text: e.target.textContent.trim()
                };
            } else if (objectType === 'relation') {
                objectInfo = {
                    object_type: 'relation',
                    type: e.target.getAttribute('data-type'),
                    id: e.target.getAttribute('data-id'),
                    text: e.target.textContent.trim()
                };
            }
            
            // 检查是否已选择
            const existingIndex = selectedLabelsForRelation.findIndex(
                obj => obj.id === objectInfo.id && obj.object_type === objectInfo.object_type
            );
            
            if (existingIndex !== -1) {
                // 取消选择
                selectedLabelsForRelation.splice(existingIndex, 1);
                e.target.style.background = objectType === 'label' ? '#f0f0f0' : '#fff3cd';
                e.target.style.borderColor = objectType === 'label' ? '#ddd' : '#ffeaa7';
                e.target.style.color = '#333';
            } else {
                // 添加选择
                if (selectedLabelsForRelation.length >= 2) {
                    alert('最多只能选择两个对象');
                    return;
                }
                selectedLabelsForRelation.push(objectInfo);
                e.target.style.background = '#e3f2fd';
                e.target.style.borderColor = '#2196f3';
                e.target.style.color = '#1976d2';
            }
            
            updateRelationUI();
        }

        // 关系类型选择事件
        if (e.target.classList.contains('relation-type-selector')) {
            // 重置所有关系类型按钮
            document.querySelectorAll('.relation-type-selector').forEach(btn => {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-warning');
            });
            
            // 选中当前关系类型
            e.target.classList.remove('btn-outline-warning');
            e.target.classList.add('btn-warning');
            
            selectedRelationType = {
                name: e.target.getAttribute('data-name'),
                color: e.target.getAttribute('data-color')
            };
            
            updateRelationUI();
        }
    });

    // 获取CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 删除关系
    function deleteRelation(relationId, buttonElement) {
        // 创建确认对话框
        const confirmBox = document.createElement('div');
        confirmBox.style.position = 'fixed';
        confirmBox.style.top = '50%';
        confirmBox.style.left = '50%';
        confirmBox.style.transform = 'translate(-50%, -50%)';
        confirmBox.style.background = 'white';
        confirmBox.style.padding = '25px';
        confirmBox.style.borderRadius = '12px';
        confirmBox.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
        confirmBox.style.zIndex = '2000';
        confirmBox.style.minWidth = '350px';
        confirmBox.style.textAlign = 'center';
        confirmBox.style.animation = 'fadeIn 0.3s ease-out';

        const relationCard = buttonElement.closest('.relation-card');
        const relationType = relationCard.querySelector('.relation-type').textContent.trim();
        const relationDetail = relationCard.querySelector('.relation-detail').textContent.trim();
        
        confirmBox.innerHTML = `
            <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                <i class="fas fa-unlink"></i>
            </div>
            <h4 style="margin-bottom:15px;color:#333;">确认删除关系</h4>
            <p style="margin-bottom:20px;color:#666;">
                您确定要删除关系 "<strong>${relationType}</strong>" 吗？<br>
                <small style="color:#999;">${relationDetail}</small><br>
                <small style="color:#999;">关系ID: ${relationId}</small>
            </p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button id="cancelDeleteRelation" class="btn btn-secondary">取消</button>
                <button id="confirmDeleteRelation" class="btn btn-danger">确认删除</button>
            </div>
        `;

        // 创建遮罩层
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '1999';

        document.body.appendChild(overlay);
        document.body.appendChild(confirmBox);

        // 取消删除
        document.getElementById('cancelDeleteRelation').onclick = function() {
            document.body.removeChild(overlay);
            document.body.removeChild(confirmBox);
        };

        // 确认删除
        document.getElementById('confirmDeleteRelation').onclick = function() {
            // 显示加载状态
            confirmBox.innerHTML = `
                <div style="color:#1a73e8;font-size:48px;margin-bottom:15px;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h4 style="margin-bottom:15px;color:#333;">正在删除关系...</h4>
                <p style="color:#666;">请稍候，正在处理您的请求</p>
            `;

            // 发送删除请求
            fetch(`/details/showitem/{{ task.task_id }}/{{ item.id }}/delete_relation/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    relation_id: relationId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 成功删除，显示成功消息
                    confirmBox.innerHTML = `
                        <div style="color:#4caf50;font-size:48px;margin-bottom:15px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 style="margin-bottom:15px;color:#333;">删除成功</h4>
                        <p style="color:#666;">关系已成功删除</p>
                    `;
                    
                    // 从页面中移除关系卡片
                    setTimeout(() => {
                        relationCard.style.transition = 'all 0.3s ease';
                        relationCard.style.opacity = '0';
                        relationCard.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            relationCard.remove();
                            
                            // 检查是否还有关系，如果没有则显示空状态
                            const relationsList = document.getElementById('relationsList');
                            if (relationsList.children.length === 0) {
                                relationsList.innerHTML = `
                                    <div class="text-muted" style="padding: 20px; text-align: center; background: #f8f9fa; border: 1px dashed #ddd; border-radius: 8px;">
                                        <i class="fas fa-exclamation-circle"></i> 当前语料暂无已标注关系
                                    </div>
                                `;
                            }
                        }, 300);
                    }, 1000);
                    
                    // 1.5秒后关闭对话框
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                        document.body.removeChild(confirmBox);
                    }, 1500);
                } else {
                    // 删除失败
                    confirmBox.innerHTML = `
                        <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h4 style="margin-bottom:15px;color:#333;">删除失败</h4>
                        <p style="margin-bottom:20px;color:#666;">${data.message}</p>
                        <button class="btn btn-primary" onclick="this.closest('.overlay').click()">确定</button>
                    `;
                }
            })
            .catch(error => {
                console.error('删除关系时出错:', error);
                confirmBox.innerHTML = `
                    <div style="color:#f44336;font-size:48px;margin-bottom:15px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 style="margin-bottom:15px;color:#333;">网络错误</h4>
                    <p style="margin-bottom:20px;color:#666;">删除关系时发生网络错误，请检查网络连接后重试</p>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.click()">确定</button>
                `;
            });
        };

        // 支持ESC键取消
        const handleKeyDown = function(e) {
            if (e.key === 'Escape') {
                document.body.removeChild(overlay);
                document.body.removeChild(confirmBox);
                document.removeEventListener('keydown', handleKeyDown);
            }
        };
        document.addEventListener('keydown', handleKeyDown);

        // 点击遮罩层取消
        overlay.onclick = function() {
            document.body.removeChild(overlay);
            document.body.removeChild(confirmBox);
            document.removeEventListener('keydown', handleKeyDown);
        };
    }
</script>
</body>
</html>